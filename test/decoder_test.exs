defmodule Xav.DecoderTest do
  use ExUnit.Case, async: true

  @vp8_keyframe <<80, 188, 0, 157, 1, 42, 128, 2, 224, 1, 57, 107, 0, 47, 28, 34, 22, 22, 34, 102,
                  18, 32, 212, 14, 239, 198, 191, 249, 103, 67, 12, 209, 59, 136, 119, 231, 148,
                  71, 190, 250, 205, 56, 167, 146, 195, 27, 246, 83, 183, 213, 135, 180, 90, 89,
                  245, 142, 137, 25, 231, 188, 158, 193, 127, 253, 250, 159, 78, 244, 58, 228,
                  245, 85, 17, 60, 238, 231, 248, 173, 93, 56, 91, 8, 237, 147, 88, 153, 113, 51,
                  216, 209, 121, 113, 94, 108, 141, 79, 9, 69, 31, 25, 96, 117, 112, 75, 211, 110,
                  238, 92, 14, 106, 206, 195, 197, 4, 70, 79, 77, 249, 99, 68, 15, 195, 242, 233,
                  38, 42, 163, 136, 195, 132, 32, 246, 164, 116, 192, 41, 214, 49, 201, 5, 11, 85,
                  98, 239, 249, 93, 48, 135, 223, 250, 190, 150, 98, 51, 157, 195, 88, 142, 143,
                  65, 59, 47, 177, 210, 96, 210, 107, 101, 173, 129, 161, 29, 165, 113, 16, 41,
                  122, 27, 101, 179, 39, 71, 55, 169, 216, 178, 226, 50, 215, 188, 228, 234, 204,
                  196, 240, 38, 134, 50, 101, 13, 137, 128, 221, 34, 83, 63, 67, 223, 196, 25, 8,
                  225, 56, 23, 219, 177, 10, 8, 218, 243, 57, 141, 171, 100, 227, 140, 14, 152,
                  105, 93, 35, 153, 244, 190, 142, 63, 74, 38, 201, 221, 96, 62, 104, 126, 13, 15,
                  79, 137, 138, 205, 173, 133, 205, 115, 114, 142, 132, 68, 17, 52, 48, 14, 105,
                  114, 139, 116, 185, 237, 119, 206, 148, 180, 228, 141, 209, 104, 141, 14, 32,
                  241, 10, 184, 90, 153, 173, 142, 1, 206, 93, 206, 17, 148, 237, 180, 49, 70, 8,
                  152, 211, 167, 131, 244, 59, 117, 113, 82, 128, 130, 124, 64, 50, 202, 107, 152,
                  201, 11, 176, 213, 201, 15, 130, 121, 85, 92, 208, 132, 248, 87, 48, 82, 244,
                  135, 180, 58, 60, 230, 114, 218, 10, 108, 57, 168, 216, 133, 76, 140, 71, 120,
                  138, 173, 21, 34, 251, 4, 167, 220, 87, 152, 179, 71, 134, 80, 66, 105, 203, 62,
                  215, 213, 170, 108, 109, 47, 90, 231, 176, 252, 185, 253, 132, 139, 14, 108, 45,
                  61, 186, 144, 53, 101, 166, 85, 205, 189, 73, 87, 53, 14, 142, 10, 112, 225,
                  172, 10, 125, 178, 32, 128, 50, 10, 253, 31, 211, 23, 74, 138, 221, 141, 71, 46,
                  46, 78, 221, 103, 198, 30, 244, 41, 243, 50, 72, 204, 129, 238, 165, 56, 252, 3,
                  58, 152, 143, 189, 142, 105, 16, 20, 77, 46, 47, 148, 139, 77, 11, 197, 106,
                  167, 38, 123, 110, 249, 169, 133, 235, 148, 221, 126, 90, 8, 123, 23, 207, 177,
                  104, 148, 162, 243, 132, 202, 23, 25, 112, 12, 160, 184, 229, 77, 145, 115, 204,
                  100, 53, 176, 68, 35, 131, 237, 25, 57, 112, 247, 223, 135, 19, 102, 161, 71,
                  223, 40, 204, 61, 206, 180, 196, 33, 19, 86, 191, 156, 234, 73, 124, 250, 252,
                  194, 113, 124, 5, 176, 58, 44, 193, 137, 128, 191, 143, 180, 219, 24, 172, 120,
                  102, 131, 15, 8, 12, 250, 182, 107, 93, 178, 192, 231, 49, 161, 105, 30, 29, 94,
                  38, 232, 49, 24, 99, 101, 115, 202, 237, 127, 60, 222, 168, 5, 14, 226, 74, 29,
                  8, 1, 56, 137, 42, 115, 142, 182, 34, 163, 3, 138, 73, 60, 192, 61, 136, 197,
                  151, 218, 90, 103, 155, 78, 37, 242, 147, 118, 212, 19, 37, 164, 85, 15, 122,
                  108, 190, 66, 167, 233, 44, 7, 227, 237, 27, 136, 167, 172, 204, 118, 115, 144,
                  17, 104, 95, 94, 165, 14, 123, 199, 69, 56, 127, 232, 29, 150, 219, 252, 141,
                  92, 95, 4, 8, 183, 244, 72, 200, 33, 246, 171, 150, 162, 120, 4, 175, 140, 94,
                  38, 211, 201, 203, 239, 185, 159, 148, 8, 246, 238, 143, 183, 58, 164, 132, 245,
                  213, 67, 69, 42, 189, 248, 227, 25, 52, 97, 151, 75, 42, 212, 104, 249, 72, 39,
                  22, 56, 252, 155, 173, 172, 126, 154, 5, 68, 60, 181, 153, 22, 214, 200, 174,
                  70, 160, 113, 250, 157, 52, 34, 195, 233, 3, 147, 62, 78, 34, 218, 164, 183,
                  230, 105, 30, 183, 50, 160, 250, 159, 73, 33, 241, 58, 22, 169, 195, 203, 255,
                  3, 41, 102, 213, 119, 162, 98, 84, 37, 219, 233, 86, 243, 185, 177, 153, 69,
                  212, 97, 239, 27, 56, 173, 210, 59, 76, 88, 18, 93, 185, 72, 104, 215, 221, 22,
                  131, 216, 19, 86, 210, 0, 187, 47, 2, 182, 157, 40, 171, 87, 68, 191, 230, 167,
                  225, 38, 32, 153, 78, 165, 190, 187, 240, 94, 35, 28, 217, 35, 40, 236, 218, 81,
                  252, 42, 39, 14, 222, 254, 98, 231, 102, 168, 176, 147, 225, 19, 5, 137, 197, 9,
                  218, 73, 143, 186, 225, 176, 221, 53, 21, 14, 237, 138, 136, 193, 21, 87, 144,
                  221, 236, 202, 69, 2, 101, 197, 203, 10, 190, 80, 43, 18, 113, 167, 45, 162, 22,
                  26, 154, 153, 81, 76, 242, 106, 217, 93, 193, 112, 163, 13, 223, 161, 124, 93,
                  246, 67, 224, 190, 60, 143, 128, 188, 110, 191, 30, 25, 251, 221, 128, 76, 176,
                  220, 252, 194, 248, 170, 113, 243, 187, 213, 209, 135, 102, 182, 167, 255, 139,
                  77, 37, 173, 195, 231, 67, 182, 172, 121, 238, 104, 213, 120, 61, 138, 193, 190,
                  8, 15, 82, 60, 172, 68, 43, 14, 57, 244, 32, 41, 212, 196, 186, 155, 252, 85,
                  172, 235, 68, 113, 152, 136, 209, 158, 171, 180, 209, 165, 157, 124, 125, 4,
                  217, 43, 140, 143, 204, 223, 115, 186, 33, 220, 176, 170, 2, 222, 49, 4, 52,
                  220, 148, 39, 30, 135, 243, 235, 248, 88, 242, 92, 102, 171, 4, 251, 11, 134,
                  165, 42, 32, 161, 12, 25, 12, 128, 60, 190, 147, 184, 251, 81, 203, 247, 15,
                  234, 230, 68, 222, 179, 179, 66, 167, 126, 237, 32, 111, 50, 98, 247, 225, 26,
                  117, 133, 98, 42, 177, 25, 167, 137, 172, 47, 91, 123, 230, 176, 198, 252, 187,
                  160, 25, 13, 249, 103, 118, 195, 141, 217, 138, 197, 11, 249, 44, 79, 102, 188,
                  149, 31, 158, 29, 145, 155, 68, 159, 158, 223, 250, 173, 98, 148, 129, 72, 149,
                  21, 193, 171, 112, 191, 88, 26, 152, 211, 14, 134, 173, 187, 250, 189, 47, 28,
                  156, 160, 241, 65, 108, 91, 112, 198, 206, 197, 140, 50, 217, 206, 196, 93, 250,
                  141, 63, 57, 214, 225, 8, 209, 163, 139, 15, 25, 255, 150, 4, 29, 252, 181, 48,
                  193, 6, 135, 133, 7, 89, 233, 178, 167, 10, 70, 31, 91, 251, 216, 141, 82, 4,
                  214, 30, 44, 97, 35, 204, 161, 149, 108, 166, 206, 146, 149, 236, 145, 161, 72,
                  105, 151, 194, 125, 101, 81, 186, 15, 23, 64, 183, 98, 79, 154, 159, 233, 107,
                  79, 212, 127, 131, 125, 60, 43, 90, 130, 18, 229, 224, 1, 105, 105, 84, 51, 227,
                  80, 236, 195, 190, 138, 240, 185, 113, 67, 78, 224, 65, 241, 106, 110, 193, 210,
                  40, 102, 98, 120, 1, 239, 92, 83, 180, 208, 116, 248, 17, 13, 178, 139, 232,
                  227, 140, 56, 114, 232, 63, 83, 83, 211, 205, 11, 213, 20, 239, 66, 35, 133, 86,
                  25, 158, 164, 156, 88, 62, 106, 109, 229, 218, 71, 3, 249, 232, 179, 4, 129, 94,
                  13, 221, 243, 191, 176, 143, 42, 230, 205, 184, 43, 97, 230, 123, 195, 50, 157,
                  226, 20, 9, 34, 127, 90, 97, 236, 50, 95, 88, 222, 224, 13, 86, 221, 156, 90,
                  24, 241, 9, 127, 193, 53, 164, 203, 217, 222, 16, 142, 168, 13, 57, 44, 58, 149,
                  40, 105, 55, 148, 55, 149, 52, 72, 3, 5, 106, 147, 198, 104, 103, 34, 180, 92,
                  253, 87, 0, 34, 132, 177, 186, 225, 99, 133, 90, 70, 215, 202, 133, 87, 119,
                  163, 161, 188, 242, 24, 65, 173, 248, 170, 202, 43, 244, 29, 62, 206, 99, 212,
                  34, 141, 215, 201, 9, 91, 136, 18, 129, 33, 216, 15, 254, 211, 41, 92, 35, 78,
                  28, 86, 243, 141, 142, 55, 162, 114, 6, 23, 30, 214, 120, 8, 136, 191, 77, 27,
                  79, 81, 85, 116, 150, 171, 113, 130, 6, 218, 24, 105, 162, 182, 82, 136, 172,
                  68, 85, 175, 215, 62, 60, 253, 7, 150, 27, 46, 30, 109, 177, 174, 77, 51, 167,
                  100, 0, 28, 46, 103, 94, 236, 140, 129, 28, 116, 205, 45, 85, 236, 234, 240, 7,
                  158, 92, 131, 23, 244, 215, 192, 156, 58, 1, 205, 157, 171, 8, 179, 132, 151,
                  254, 201, 80, 207, 206, 86, 43, 27, 103, 16, 96, 17, 234, 28, 19, 178, 141, 12,
                  231, 244, 180, 224, 254, 170, 116, 14, 21, 119, 90, 99, 69, 30, 122, 152, 173,
                  250, 198, 250, 129, 127, 122, 130, 236, 229, 54, 143, 245, 226, 236, 106, 85,
                  29, 7, 93, 149, 211, 204, 235, 153, 151, 19, 170, 121, 91, 74, 24, 0, 219, 22,
                  226, 118, 227, 209, 248, 162, 170, 1, 49, 79, 111, 236, 21, 24, 53, 58, 190, 94,
                  137, 162, 96, 212, 50, 129, 222, 199, 115, 170, 113, 18, 119, 54, 103, 140, 28,
                  21, 135, 227, 122, 73, 33, 209, 120, 44, 46, 29, 105, 153, 191, 142, 252, 9,
                  249, 6, 182, 63, 153, 146, 84, 231, 30, 148, 44, 59, 24, 237, 104, 216, 162, 22,
                  206, 32, 158, 167, 144, 123, 35, 1, 135, 164, 144, 224, 59, 204, 178, 14, 248,
                  24, 66, 72, 161, 136, 144, 154, 250, 148, 99, 42, 211, 161, 74, 133, 104, 246,
                  148, 180, 29, 85, 1, 35, 121, 140, 65, 87, 108, 43, 135, 93, 147, 56, 104, 44,
                  4, 124, 214, 179, 166, 146, 31, 155, 28, 235, 123, 77, 113, 194, 82, 139, 74, 6,
                  85, 57, 9, 234, 67, 9, 109, 43, 182, 245, 113, 140, 100, 149, 204, 230, 11, 72,
                  153, 6, 177, 145, 194, 30, 193, 97, 215, 80, 1, 185, 141, 31, 42, 164, 172, 40,
                  103, 74, 186, 228, 239, 81, 49, 38, 71, 58, 5, 184, 235, 77, 73, 31, 56, 177,
                  102, 236, 44, 148, 84, 204, 177, 142, 150, 222, 174, 52, 193, 245, 248, 12, 92,
                  198, 70, 171, 219, 20, 75, 77, 117, 68, 170, 214, 47, 229, 18, 77, 52, 215, 28,
                  190, 90, 161, 64, 52, 182, 42, 140, 218, 183, 212, 187, 116, 54, 153, 99, 184,
                  69, 135, 172, 127, 234, 210, 216, 29, 107, 22, 121, 116, 147, 5, 20, 46, 123,
                  71, 108, 68, 134, 49, 137, 36, 79, 226, 190, 223, 78, 22, 96, 211, 208, 106, 62,
                  187, 0, 120, 196, 137, 54, 15, 195, 1, 241, 131, 129, 62, 232, 224, 99, 113, 17,
                  189, 58, 217, 13, 238, 82, 213, 197, 130, 209, 159, 59, 54, 142, 116, 35, 44,
                  147, 183, 8, 98, 74, 182, 89, 232, 79, 31, 195, 81, 79, 138, 56, 161, 250, 222,
                  15, 104, 205, 223, 249, 218, 72, 106, 101, 105, 11, 230, 46, 116, 234, 202, 187,
                  208, 11, 235, 125, 145, 85, 35, 235, 66, 203, 60, 39, 197, 10, 119, 14, 230, 78,
                  11, 86, 67, 109, 143, 245, 153, 110, 128, 136, 122, 97, 174, 73, 185, 169, 70,
                  183, 125, 129, 184, 180, 0, 0, 54, 200, 216, 241, 53, 74, 31, 97, 250, 49, 106,
                  140, 213, 229, 113, 14, 133, 170, 103, 9, 111, 125, 70, 126, 193, 134, 49, 176,
                  104, 44, 39, 184, 202, 189, 117, 216, 78, 216, 212, 84, 59, 35, 230, 223, 213,
                  133, 0, 75, 113, 111, 106, 125, 153, 242, 76, 4, 18, 161, 158, 100, 192, 89,
                  170, 153, 146, 62, 45, 251, 43, 216, 208, 230, 17, 43, 101, 50, 183, 42, 212,
                  37, 123, 76, 50, 240, 82, 84, 112, 12, 243, 194, 35, 49, 76, 28, 75, 89, 104,
                  107, 23, 89, 14, 226, 70, 60, 79, 67, 255, 193, 171, 114, 41, 50, 20, 133, 55,
                  92, 117, 109, 196, 49, 224, 27, 144, 142, 72, 20, 114, 250, 208, 107, 226, 225,
                  55, 41, 105, 102, 142, 242, 253, 206, 110, 87, 11, 234, 56, 251, 85, 231, 45, 1,
                  173, 4, 216, 17, 16, 49, 139, 84, 177, 100, 216, 220, 129, 248, 161, 18, 156,
                  162, 149, 128, 145, 110, 91, 226, 16, 246, 173, 128, 162, 215, 216, 118, 132,
                  99, 197, 157, 173, 150, 202, 151, 40, 56, 27, 7, 40, 226, 159, 18, 77, 186, 124,
                  175, 205, 198, 247, 154, 193, 254, 235, 13, 213, 45, 229, 166, 194, 28, 5, 228,
                  191, 102, 141, 21, 101, 229, 36, 223, 231, 20, 110, 26, 17, 64, 237, 85, 247,
                  198, 194, 204, 160, 2, 27, 246, 210, 18, 144, 10, 194, 249, 254, 119, 15, 22,
                  26, 9, 31, 136, 86, 236, 25, 214, 65, 134, 11, 108, 188, 252, 180, 190, 98, 238,
                  126, 193, 7, 234, 219, 47, 102, 186, 83, 249, 109, 248, 12, 84, 0, 40, 247, 169,
                  8, 131, 183, 214, 128, 170, 250, 6, 179, 220, 6, 57, 178, 3, 167, 125, 123, 176,
                  171, 21, 33, 152, 92, 65, 180, 89, 101, 237, 125, 219, 7, 100, 195, 80, 81, 29,
                  160, 109, 121, 179, 215, 176, 232, 230, 218, 93, 197, 90, 2, 114, 31, 197, 80,
                  19, 240, 232, 255, 189, 246, 98, 255, 170, 107, 112, 106, 238, 27, 24, 135, 141,
                  10, 25, 251, 109, 224, 70, 151, 182, 64, 92, 105, 63, 61, 226, 113, 193, 243,
                  235, 51, 16, 48, 253, 209, 160, 124, 10, 61, 192, 12, 125, 57, 16, 177, 123,
                  213, 22, 120, 109, 9, 217, 28, 161, 237, 7, 217, 22, 206, 88, 46, 49, 91, 95,
                  11, 39, 49, 32, 69, 92, 224, 236, 170, 4, 162, 61, 248, 80, 94, 16, 104, 16, 34,
                  192, 214, 24, 141, 37, 137, 88, 112, 49, 56, 110, 179, 90, 4, 241, 142, 35, 107,
                  200, 206, 129, 170, 138, 24, 107, 138, 171, 87, 243, 29, 37, 158, 75, 167, 37,
                  232, 13, 218, 97, 17, 104, 12, 85, 38, 57, 31, 103, 54, 149, 30, 62, 47, 204,
                  209, 68, 27, 179, 28, 15, 194, 142, 162, 81, 253, 80, 153, 209, 205, 1, 125, 24,
                  74, 3, 251, 117, 144, 180, 238, 179, 24, 43, 139, 155, 53, 216, 231, 49, 173,
                  96, 39, 203, 249, 129, 199, 170, 246, 18, 76, 195, 77, 179, 58, 200, 154, 15,
                  16, 68, 1, 236, 133, 206, 137, 186, 125, 203, 164, 92, 180, 155, 194, 69, 76,
                  144, 98, 64, 249, 0, 173, 26, 217, 108, 225, 47, 167, 144, 60, 187, 117, 92,
                  105, 152, 35, 123, 33, 30, 137, 17, 94, 135, 156, 169, 60, 123, 45, 14, 22, 178,
                  89, 57, 130, 180, 243, 12, 73, 71, 181, 196, 50, 226, 231, 144, 77, 138, 222,
                  212, 39, 72, 148, 167, 131, 242, 101, 77, 141, 193, 4, 241, 118, 203, 130, 18,
                  141, 51, 169, 211, 78, 134, 166, 187, 63, 79, 216, 178, 173, 138, 104, 48, 200,
                  15, 239, 38, 67, 74, 219, 28, 51, 40, 170, 219, 164, 88, 186, 236, 163, 254,
                  191, 181, 13, 151, 18, 108, 46, 134, 189, 103, 94, 28, 88, 181, 201, 86, 76, 1,
                  7, 59, 35, 39, 180, 63, 183, 100, 111, 235, 158, 182, 19, 93, 213, 87, 76, 10,
                  151, 207, 121, 218, 226, 139, 127, 21, 233, 63, 24, 192, 252, 85, 171, 107, 165,
                  207, 212, 246, 139, 84, 203, 177, 203, 51, 118, 150, 1, 209, 200, 219, 202, 59,
                  164, 222, 24, 121, 174, 101, 138, 176, 255, 164, 138, 154, 106, 18, 21, 136,
                  193, 250, 229, 170, 157, 86, 106, 26, 55, 180, 254, 107, 232, 123, 126, 16, 221,
                  9, 12, 116, 217, 229, 204, 11, 130, 195, 93, 33, 219, 224, 43, 200, 120, 244,
                  207, 173, 77, 35, 155, 125, 68, 60, 125, 112, 144, 175, 121, 208, 105, 249, 144,
                  217, 210, 41, 173, 19, 117, 92, 219, 249, 115, 219, 181, 194, 214, 100, 84, 173,
                  76, 18, 176, 45, 182, 35, 132, 83, 145, 141, 15, 152, 67, 171, 68, 204, 147,
                  219, 31, 222, 75, 162, 23, 6, 171, 114, 118, 97, 93, 201, 19, 101, 208, 182, 24,
                  16, 188, 80, 113, 103, 94, 42, 250, 14, 244, 156, 51, 184, 188, 228, 11, 162,
                  253, 54, 95, 0, 250, 143, 251, 22, 129, 181, 146, 75, 60, 67, 110, 173, 110,
                  134, 139, 153, 145, 90, 64, 226, 126, 14, 144, 232, 218, 141, 153, 48, 163, 83,
                  49, 236, 13, 17, 11, 56, 62, 136, 1, 63, 95, 118, 49, 49, 100, 2, 203, 217, 31,
                  32, 141, 14, 144, 0>>

  @opus_frame <<120, 12, 65, 10, 226, 218, 78, 44, 178, 170, 67, 85, 217, 117, 65, 205, 95, 118,
                107, 76, 36, 55, 13, 188, 245, 18, 11, 194, 57, 176, 212, 48, 198, 41, 85, 192,
                142, 204, 5, 106, 217, 175, 162, 62, 128, 161, 69, 136, 234, 30, 43, 165, 152,
                104, 143>>

  test "new/0" do
    assert {:ok, decoder} = Xav.Decoder.new(:vp8)
    assert is_reference(decoder)

    assert {:ok, decoder} = Xav.Decoder.new(:opus)
    assert is_reference(decoder)

    assert_raise(ErlangError, fn -> Xav.Decoder.new(:unknown) end)
  end

  describe "decode/2" do
    test "audio" do
      {:ok, decoder} = Xav.Decoder.new(:opus)

      assert {:ok, %Xav.Frame{samples: 960, pts: 0, format: :flt}} =
               Xav.Decoder.decode(decoder, @opus_frame, 0, 0)
    end

    test "video" do
      {:ok, decoder} = Xav.Decoder.new(:vp8)

      assert {:ok, %Xav.Frame{width: 640, height: 480, pts: 0, format: :rgb}} =
               Xav.Decoder.decode(decoder, @vp8_keyframe, 0, 0)
    end
  end
end
